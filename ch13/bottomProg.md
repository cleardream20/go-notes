# åº•å±‚ç¼–ç¨‹
æŠŠCå­¦é•¿å«è¿‡æ¥ï¼ğŸ˜‹

# unsafe
`package unsafe`ï¼Œåº•å±‚ç¼–ç¨‹çš„å±é™©æ´¾å¯¹~

## unsafe.Sizeof
æ±‚å˜é‡/ç±»å‹åœ¨å†…å­˜ä¸­å ç”¨çš„å­—èŠ‚æ•°
e.g.
```go
    var i int
	var f float64
	var s string = "hello"
	
	fmt.Println("int size:", unsafe.Sizeof(i))      // é€šå¸¸8å­—èŠ‚(64ä½ç³»ç»Ÿ)
	fmt.Println("float64 size:", unsafe.Sizeof(f))  // 8å­—èŠ‚
	fmt.Println("string size:", unsafe.Sizeof(s))   // 16å­—èŠ‚(64ä½ç³»ç»Ÿ)
	
	type Person struct {
		Name string
		Age  int
	}
	fmt.Println("struct size:", unsafe.Sizeof(Person{}))  // 24å­—èŠ‚(16+8)
```

## unsafe.Alignof & unsafe.Offsetof
å†…å­˜åœ°å€å¯¹é½ï¼Ÿ

å†…å­˜å¯¹é½æ˜¯æŒ‡æ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜å‚¨èµ·å§‹åœ°å€å¿…é¡»æ˜¯æŸä¸ªå€¼ï¼ˆé€šå¸¸æ˜¯2ã€4ã€8ç­‰2çš„å¹‚æ¬¡æ–¹ï¼‰çš„æ•´æ•°å€
e.g.
```go
var x struct {
    a bool // 1å­—èŠ‚
    b int16 // 2å­—èŠ‚
    c [] int // å¦‚ä¸‹å›¾æ‰€ç¤º
}
```
<img src="http://docs.hundan.org/gopl-zh/images/ch13-01.png" />

ï¼ˆ32/64ä½ç³»ç»Ÿä¸ä¸€æ ·ï¼‰

å¯¹é½å€¼é€šå¸¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œç»“æ„ä½“çš„å¯¹é½å€¼ç”±å…¶å­—æ®µä¸­æœ€å¤§çš„å¯¹é½å€¼å†³å®šï¼Œå¯¹é½åæ–¹ä¾¿åç»­å†…å­˜è®¿é—®

ä¸ºäº†å¯¹é½å¯èƒ½ä¼šå‡ºç°ç©ºæ´ï¼ˆå›¾ä¸­ç°è‰²éƒ¨åˆ†ï¼‰ï¼Œä½†è¿™ä¹Ÿç®—åœ¨æ¶ˆè€—çš„å†…å­˜ä¸­

---
`Alignof()`è¿”å›å¯¹åº”å‚æ•°çš„ç±»å‹éœ€è¦å¯¹é½çš„å€æ•°

å¸¸æƒ…å†µä¸‹å¸ƒå°”å’Œæ•°å­—ç±»å‹éœ€è¦å¯¹é½åˆ°å®ƒä»¬æœ¬èº«çš„å¤§å°ï¼ˆæœ€å¤š8ä¸ªå­—èŠ‚ï¼‰ï¼Œå…¶å®ƒçš„ç±»å‹å¯¹é½åˆ°æœºå™¨å­—å¤§å°

e.g.
| ç±»å‹        | å¤§å° | å¯¹é½å€¼(Alignofè¿”å›å€¼) | è§£é‡Š                          |
|------------|------|----------------------|-----------------------------|
| `bool`     | 1    | 1                    | å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°å€ï¼ˆ1çš„å€æ•°ï¼‰         |
| `int8`     | 1    | 1                    | åŒbool                      |
| `int16`    | 2    | 2                    | èµ·å§‹åœ°å€å¿…é¡»æ˜¯2çš„å€æ•°             |
| `int32`    | 4    | 4                    | èµ·å§‹åœ°å€å¿…é¡»æ˜¯4çš„å€æ•°             |
| `int64`    | 8    | 8                    | èµ·å§‹åœ°å€å¿…é¡»æ˜¯8çš„å€æ•°             |
| `float64`  | 8    | 8                    | åŒint64                     |
| `string`   | 16   | 8                    | è™½ç„¶æ€»å¤§å°16å­—èŠ‚ï¼Œä½†æŒ‰æœºå™¨å­—(8å­—èŠ‚)å¯¹é½ |
| `[]int`    | 24   | 8                    | åˆ‡ç‰‡æè¿°ç¬¦æŒ‰æœºå™¨å­—å¯¹é½             |

---
`Offsetof()`
å¿…é¡»æ˜¯ç»“æ„ä½“çš„æŸä¸ªå­—æ®µ`x.f`ï¼Œè¿”å›`f`å­—æ®µç›¸å¯¹äº`x`èµ·å§‹åœ°å€çš„åç§»é‡

e.g.
```go
func unsafeEx2() {
	type P struct {
		a bool // 1å­—èŠ‚ï¼Œå¯¹é½åˆ°1å­—èŠ‚
		b int16 // 2å­—èŠ‚ï¼Œå¯¹é½åˆ°2å­—èŠ‚
		c []int // 3x8å­—èŠ‚ï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼Œå¯¹é½åˆ°æœºå™¨å­—é•¿8å­—èŠ‚
	}
	x := P{}
	fmt.Println("Sizeof:", unsafe.Sizeof(x.a), unsafe.Sizeof(x.b), unsafe.Sizeof(x.c))
	fmt.Println("Alignof:", unsafe.Alignof(x.a), unsafe.Alignof(x.b), unsafe.Alignof(x.c))
	fmt.Println("Offsetof:", unsafe.Offsetof(x.a), unsafe.Offsetof(x.b), unsafe.Offsetof(x.c))
}
```

ç»“æœï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼š
```sh
Sizeof: 1 2 24
Alignof: 1 2 8
Offsetof: 0 2 8 # å¦‚ä¸Šé¢çš„å›¾æ‰€ç¤º
```

## unsafe.Pointer
æŒ‡é’ˆï¼Ÿåº•å±‚ä¸è€é“ï¼Ÿï¼ğŸ˜‹ğŸ‘
`*T`æŒ‡å‘Tç±»å‹çš„æŒ‡é’ˆ
é‚£`unsafe.Pointer`ä½ æ¥å¹²å˜›çš„

ç±»ä¼¼Cä¸­çš„`void* `ç±»å‹çš„æŒ‡é’ˆï¼Œå¯ä»¥åŒ…å«ä»»æ„ç±»å‹å˜é‡çš„åœ°å€

---
`*T`å’Œ`unsafe.Pointer`äº’è½¬
e.g.
```go
// *float64 -> *uint64
func Float64bits(f float64) uint64 { return *(*uint64)(unsafe.Pointer(&f)) }

fmt.Printf("%#016x\n", Float64bits(1.0)) // "0x3ff0000000000000"
```
è¯´å®è¯ğŸ¤”

æœ‰ç‚¹ç¥ç»äº†ğŸ˜‹

---
è·å–ç»“æ„ä½“å­—æ®µ
```go
var x struct {
    a bool
    b int16
    c []int
}

// å’Œ pb := &x.b ç­‰ä»·
pb := (*int16)(unsafe.Pointer(
    uintptr(unsafe.Pointer(&x)) + unsafe.Offsetof(x.b)))
*pb = 42
fmt.Println(x.b) // "42"
```
è¯´å®è¯ğŸ¤”

æ›´ç¥ç»äº†ğŸ˜‹ğŸ˜‹

---
uintptré—­å˜´
`uintptr`å¯ä»¥å­˜å‚¨ä¸€ä¸ª å’Œå½“å‰æŒ‡é’ˆç›¸åŒçš„æ•°å­—å€¼ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆ

å› ä¸ºGoçš„GCåƒåœ¾å›æ”¶å¯èƒ½ä¼šå¯¼è‡´å˜é‡çš„å†…å­˜åœ°å€å‘ç”Ÿå˜åŒ–ï¼ŒæŒ‡é’ˆæœ‰ä¸œè¥¿æŒ‡ï¼Œæ‰€ä»¥çŸ¥é“ï¼Œä¼šè·Ÿç€å˜ï¼›ä½†æ˜¯`uintptr`å°±æ˜¯ä¸€ä¸ªå®šæ­»çš„æ•°ï¼Œå®ƒä¸ä¼šè·Ÿç€å˜ï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦å¼•å…¥ä¸€ä¸ª`uintptr`ç±»å‹çš„ä¸­é—´å˜é‡å¹¶æŠŠå®ƒä½œä¸º`unsafe.Pointer()`çš„å‚æ•°ï¼

e.g.
```go
tmp := uintptr(unsafe.Pointer(&x)) + unsafe.Offsetof(x.b) // uintptrç±»å‹ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„æ•°ï¼Œæ¯”å¦‚è¯´2
pb := (*int16)(unsafe.Pointer(tmp)) // å¯èƒ½å†…å­˜åœ°å€å·²ç»å˜äº†ï¼ˆæ¯”å¦‚åŸæ¥2ä½ç½®çš„å˜åˆ°1ä½ç½®äº†ï¼‰ï¼Œä½†uintptrç±»å‹çš„tmpè¿˜æ²¡æœ‰å˜ï¼ˆè¿˜æ˜¯2ï¼‰
*pb = 42 // æŠŠç°åœ¨åœ¨2ä½ç½®å…¶ä»–çš„ä¸œè¥¿ç»™ææ‰äº†ï¼Œé‚£ä¸æ˜¯ä¹±æäº†å—
```

å†æ¯”å¦‚
```go
pT := uintptr(unsafe.Pointer(new(T)))
// new()å®Œä¹‹åï¼Œæ²¡æœ‰æŒ‡é’ˆå¼•ç”¨å®ƒï¼ˆæ²¡æœ‰ï¼Œåƒåœ¾ï¼‰ï¼Œåƒåœ¾æ”¶é›†å™¨å¯èƒ½ç«‹é©¬å›æ”¶å…¶ç©ºé—´
// é‚£ä½ è¿˜unsafe.Pointer()ä¸ªç”šå•Šï¼Œçš‡å¸éƒ½æ²¡äº†ä½ å»å“ªä¸Šè´¡
```


# é€šè¿‡cgoè°ƒç”¨Cä»£ç 
Goé‡Œé¢è·‘Cï¼Œå“ˆåŸºGoï¼Œä½ è¿™å®¶ä¼™ï¼Œä¸ºäº†å‡»è´¥Cå­¦é•¿ä¸æƒœcosæˆCå—ï¼ŸğŸ˜‹ğŸ˜‹

## åºè¨€ & åºè¨€æ³¨é‡Š
`import "C"`â€”â€”åºè¨€
çœŸçš„æœ‰ä¸ª`C`åº“ï¼Ÿéª—ä½ çš„ï¼Œè¿™æ˜¯cosæœ

åºè¨€æ³¨é‡Šï¼Œåœ¨`import "C"`å‰é¢çš„`/* */`æ³¨é‡Šä¸­ç¼–å†™Cä»£ç ï¼Œç„¶åå°±å¯ä»¥è·‘äº†

e.g.`C.hello()`
```go
package main

/*
#include <stdio.h>

void hello() {
    printf("hello, world!\n");
}
*/
import "C"

func main() {
    C.hello() // è°ƒç”¨Cå‡½æ•°
}
```

æ³¨æ„ï¼ŒGoæ¯”è¾ƒå‚²å¨‡ï¼ˆä¸ºäº†æˆä¸ºæ ‡å‡†çš„è½®æ¤…çš„å¿…è¦ç‰ºç‰²ï¼‰
æ³¨é‡Šç”¨`//`ä¸è¡Œï¼ŒæŠ¥é”™
æ³¨é‡Šå’Œ`import "C"`ä¹‹é—´æœ‰ç©ºè¡Œä¸è¡Œï¼ŒæŠ¥é”™
Cä»£ç å†™é”™äº†ï¼Ÿä¸è¡Œï¼Œåº“åº“æŠ¥é”™

## åŸºç¡€ç”¨æ³•
### åŸºæœ¬ç±»å‹è½¬æ¢
| in C | in Go |
|--|--|
| char | C.char |
| int | C.int |
| unsigned int | C.uint |
| long | C.long |
| double | C.double |
| char* | *C.char |

### å­—ç¬¦ä¸²è½¬æ¢
```go
package main

/*
#include <string.h>
#include <stdlib.h>
*/
import "C"
import "unsafe"

func main() {
    // Go str è½¬ C
	goStr := "Hello, C!"
	cStr := C.CString(goStr)
	defer C.free(unsafe.Pointer(cStr)) // å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾å†…å­˜

	// CStringæ–¹æ³•
	length := C.strlen(cStr)
	println("String length:", length)

	// C str è½¬ Go
	goStrBack := C.GoString(cStr)
	println(goStrBack)
}
```

æœ¬æ¥æ˜¯Cé‡Œé¢çš„`strlen()`å‡½æ•°ï¼Œimportè¿›æ¥ä¹‹åç›´æ¥`C.strlen()`å°±OK

### ç»“æ„ä½“
è®©Goå°å…„å¼Ÿçœ‹çœ‹`typedef struct{}`

```go
package main

/*
typedef struct {
    int x;
    int y;
} Point;

int sum(Point p) {
    return p.x + p.y;
}
*/
import "C"
import "fmt"

func main() {
    p := C.Point{x: 10, y: 20}
    result := C.sum(p)
    fmt.Println("Sum:", result) // è¾“å‡º: Sum: 30
}
```

## `#cgo`é“¾æ¥Cåº“
`#cgo`æŒ‡ä»¤è¯­æ³•
```go
/*
#cgo [GOOS/GOARCH...] [CFLAGS/LDFLAGS...] ç¼–è¯‘é€‰é¡¹
*/
```

e.g.
```go
/*
#cgo CFLAGS: -I/usr/local/include
#cgo LDFLAGS: -L/usr/local/lib -lfoo
#cgo windows LDFLAGS: -lbar
*/
```

çœ‹ä¸æ‡‚æ€å¯†è¾¾ğŸ˜‹
ï¼ˆä¸Šå®Œç¼–è¯‘åŸç†å†è¯´å§ï¼‰

# åœ£ç»çš„è¯„ä»·
ch12 å’Œ ch13æ˜¯ä¸æ˜¯å¾ˆåº•å±‚å¾ˆæŠ½è±¡ï¼Ÿé‚£åœ£ç»æ˜¯å¦‚ä½•è¯„ä»·çš„å‘¢ï¼Ÿ

ã€Šè™½ç„¶åå°„æä¾›çš„APIè¿œå¤šäºæˆ‘ä»¬è®²åˆ°çš„ï¼Œæˆ‘ä»¬å‰é¢çš„ä¾‹å­ä¸»è¦æ˜¯ç»™å‡ºäº†ä¸€ä¸ªæ–¹å‘ï¼Œé€šè¿‡åå°„å¯ä»¥å®ç°å“ªäº›åŠŸèƒ½ã€‚åå°„æ˜¯ä¸€ä¸ªå¼ºå¤§å¹¶å¯Œæœ‰è¡¨è¾¾åŠ›çš„å·¥å…·ï¼Œä½†æ˜¯å®ƒåº”è¯¥è¢«å°å¿ƒåœ°ä½¿ç”¨ã€‹

ã€Šæˆ‘ä»¬åœ¨å‰ä¸€ç« ç»“å°¾çš„æ—¶å€™ï¼Œæˆ‘ä»¬è­¦å‘Šè¦è°¨æ…ä½¿ç”¨reflectåŒ…ã€‚é‚£äº›è­¦å‘ŠåŒæ ·é€‚ç”¨äºæœ¬ç« çš„unsafeåŒ…ã€‹

ã€Šå¤§å¤šæ•°Goç¨‹åºå‘˜å¯èƒ½æ°¸è¿œä¸ä¼šéœ€è¦ç›´æ¥ä½¿ç”¨unsafeã€‹

ã€Šç°åœ¨ï¼Œèµ¶ç´§å°†æœ€åä¸¤ç« æŠ›å…¥è„‘åå§ã€‚ç¼–å†™ä¸€äº›å®å®åœ¨åœ¨çš„åº”ç”¨æ˜¯çœŸç†ã€‚è¯·è¿œç¦»reflectå’ŒunsafeåŒ…ï¼Œé™¤éä½ ç¡®å®éœ€è¦å®ƒä»¬ã€‹

ğŸ˜‹ğŸ‘
